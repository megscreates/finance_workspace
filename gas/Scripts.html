<script>
(function(){
  const root = document.documentElement;
  const body = document.body;

  // Theme Studio state (mirrors web version)
  const studio = {
    openBtn: document.getElementById('openStudio'),
    panel: document.getElementById('themeStudio'),
    closeBtn: document.getElementById('closeStudio'),
    inputs: {
      primary: document.getElementById('stPrimary'),
      outline: document.getElementById('stOutline'),
      bgType: document.getElementById('stBgType'),
      bg1: document.getElementById('stBg1'),
      bg2: document.getElementById('stBg2'),
      bg3: document.getElementById('stBg3'),
      angle: document.getElementById('stAngle'),
      line: document.getElementById('stLine'),
      radius: document.getElementById('stRadius'),
      iconStroke: document.getElementById('stIconStroke'),
      shadow: document.getElementById('stShadow'),
      outlineStyle: document.getElementById('stOutlineStyle'),
      iconEdge: document.getElementById('stIconEdge'),
      bodyFont: document.getElementById('stBodyFont'),
      headingFont: document.getElementById('stHeadingFont'),
      scale: document.getElementById('stScale'),
      cardType: document.getElementById('stCardType'),
      card1: document.getElementById('stCard1'),
      card2: document.getElementById('stCard2'),
      sbgType: document.getElementById('stSBgType'),
      sbg1: document.getElementById('stSBg1'),
      sbg2: document.getElementById('stSBg2'),
      sbg3: document.getElementById('stSBg3'),
      sbgAngle: document.getElementById('stSBgAngle'),
      brandType: document.getElementById('stBrandType'),
      brandColor: document.getElementById('stBrandColor'),
      brand1: document.getElementById('stBrand1'),
      brand2: document.getElementById('stBrand2'),
      headType: document.getElementById('stHeadType'),
      head1: document.getElementById('stHead1'),
      head2: document.getElementById('stHead2'),
      name: document.getElementById('stPresetName'),
      saveBtn: document.getElementById('stSavePreset'),
      resetBtn: document.getElementById('stReset')
    },
    list: document.getElementById('stPresetList'),
    quick: document.getElementById('stQuickPalettes'),
    bgPreview: document.getElementById('bgPreview'),
    sbgPreview: document.getElementById('stSBgPreview')
  };

  studio.openBtn?.addEventListener('click', () => studio.panel?.setAttribute('aria-hidden', 'false'));
  studio.closeBtn?.addEventListener('click', () => studio.panel?.setAttribute('aria-hidden', 'true'));

  const setVar = (k,v)=>root.style.setProperty(k,v);
  const getVar = (k)=>getComputedStyle(root).getPropertyValue(k).trim();

  const hexToRgba=(hex,a=0.25)=>{const h=hex.replace('#','');const b=parseInt(h.length===3?h.split('').map(c=>c+c).join(''):h,16);const r=(b>>16)&255,g=(b>>8)&255,b2=b&255;return `rgba(${r}, ${g}, ${b2}, ${a})`};
  const buildBg=()=>{const t=studio.inputs.bgType.value;const c1=studio.inputs.bg1.value,c2=studio.inputs.bg2.value,c3=studio.inputs.bg3.value;const angle=studio.inputs.angle.value;if(t==='solid')return c1; if(t==='linear')return `linear-gradient(${angle}deg, ${c1} 0%, ${c2} 50%, ${c3} 100%)`; return `radial-gradient(1000px 520px at 75% -10%, ${hexToRgba(c1,0.3)}, transparent 60%), radial-gradient(900px 520px at -15% 5%, ${hexToRgba(c2,0.28)}, transparent 55%), linear-gradient(180deg, ${c3} 0%, #ffffff 100%)`};
  const buildSBg=()=>{const t=studio.inputs.sbgType.value;const c1=studio.inputs.sbg1.value,c2=studio.inputs.sbg2.value,c3=studio.inputs.sbg3.value;const angle=studio.inputs.sbgAngle.value;if(t==='solid')return c1; if(t==='linear')return `linear-gradient(${angle}deg, ${c1} 0%, ${c2} 50%, ${c3} 100%)`; return `radial-gradient(800px 500px at 20% -10%, ${hexToRgba(c1,0.45)}, transparent 60%), radial-gradient(800px 500px at 80% 110%, ${hexToRgba(c2,0.45)}, transparent 55%), linear-gradient(180deg, ${c3} 0%, ${c1} 100%)`};

  const applyStudio=()=>{
    setVar('--primary', studio.inputs.primary.value); setVar('--outline', studio.inputs.outline.value);
    setVar('--line', studio.inputs.line.value+'px'); setVar('--radius', studio.inputs.radius.value+'px');
    setVar('--icon-stroke', studio.inputs.iconStroke.value); setVar('--shadow-offset', studio.inputs.shadow.value+'px');
    setVar('--outline-style', studio.inputs.outlineStyle.value);
    const edge=studio.inputs.iconEdge.value; setVar('--icon-cap', edge==='round'?'round':'butt'); setVar('--icon-join', edge==='round'?'round':'miter');
    setVar('--font-body', studio.inputs.bodyFont.value); setVar('--font-heading', studio.inputs.headingFont.value); setVar('--font-scale', studio.inputs.scale.value);
    const bg=buildBg(); setVar('--bg', bg); if (studio.bgPreview) studio.bgPreview.style.background=bg;
    const cf = studio.inputs.cardType.value==='gradient' ? `linear-gradient(135deg, ${studio.inputs.card1.value}, ${studio.inputs.card2.value})` : studio.inputs.card1.value; setVar('--card-fill', cf);
    const sbg=buildSBg(); setVar('--sidebar-bg', sbg); if (studio.sbgPreview) studio.sbgPreview.style.background=sbg;
    if (studio.inputs.brandType.value==='gradient'){ setVar('--brand-gradient', `linear-gradient(90deg, ${studio.inputs.brand1.value}, ${studio.inputs.brand2.value})`); setVar('--brand-text-color','transparent'); }
    else { setVar('--brand-gradient','none'); setVar('--brand-text-color', studio.inputs.brandColor.value); }
    if (studio.inputs.headType.value==='solid'){ setVar('--headline-gradient', studio.inputs.head1.value); }
    else { setVar('--headline-gradient', `linear-gradient(90deg, ${studio.inputs.head1.value}, ${studio.inputs.head2.value})`); }
  };

  ['primary','outline','bgType','bg1','bg2','bg3','angle','line','radius','iconStroke','shadow','outlineStyle','iconEdge','bodyFont','headingFont','scale','cardType','card1','card2','sbgType','sbg1','sbg2','sbg3','sbgAngle','brandType','brandColor','brand1','brand2','headType','head1','head2'].forEach(k=>{
    studio.inputs[k]?.addEventListener('input', applyStudio);
  });

  function rgbToHex(rgb){ if(!rgb) return null; if(rgb.startsWith('#')) return rgb; const m = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/); if(!m) return null; const toHex=n=>('0'+parseInt(n,10).toString(16)).slice(-2); return '#'+toHex(m[1])+toHex(m[2])+toHex(m[3]); }
  function initStudioFromVars(){
    if(!studio.panel) return;
    studio.inputs.primary.value = rgbToHex(getVar('--primary')) || '#6f5cff';
    studio.inputs.outline.value = rgbToHex(getVar('--outline') || '#1f2346');
    studio.inputs.line.value = parseInt(getVar('--line') || '2');
    studio.inputs.radius.value = parseInt(getVar('--radius') || '12');
    studio.inputs.iconStroke.value = parseFloat(getVar('--icon-stroke') || '2');
    studio.inputs.shadow.value = parseInt(getVar('--shadow-offset') || '6');
    studio.inputs.outlineStyle.value = getVar('--outline-style') || 'solid';
    const cap = getVar('--icon-cap') || 'round'; studio.inputs.iconEdge.value = (cap==='round')?'round':'miter';
    studio.inputs.bodyFont.value = getVar('--font-body') || studio.inputs.bodyFont.value;
    studio.inputs.headingFont.value = getVar('--font-heading') || studio.inputs.headingFont.value;
    studio.inputs.scale.value = parseFloat(getVar('--font-scale') || '1');
    const cf = getVar('--card-fill'); studio.inputs.cardType.value = (cf && cf.startsWith('linear-gradient')) ? 'gradient' : 'plain';
    studio.bgPreview.style.background = getVar('--bg'); studio.sbgPreview.style.background = getVar('--sidebar-bg');
  }

  // Presets
  const PRESET_KEY='gas_theme_presets_v1';
  const loadPresets=()=>{try{return JSON.parse(localStorage.getItem(PRESET_KEY)||'[]')}catch{return[]}};
  const savePresets=(arr)=>localStorage.setItem(PRESET_KEY, JSON.stringify(arr));
  const varsSnapshot=()=>({
    primary:getVar('--primary'), outline:getVar('--outline'), bg:getVar('--bg'), line:getVar('--line'), radius:getVar('--radius'), iconStroke:getVar('--icon-stroke'), shadow:getVar('--shadow-offset'), outlineStyle:getVar('--outline-style'), iconCap:getVar('--icon-cap'), iconJoin:getVar('--icon-join'), fontBody:getVar('--font-body'), fontHeading:getVar('--font-heading'), fontScale:getVar('--font-scale'), cardFill:getVar('--card-fill'), sidebarBg:getVar('--sidebar-bg'), brandGradient:getVar('--brand-gradient'), brandText:getVar('--brand-text-color'), headline:getVar('--headline-gradient')
  });
  const applySnapshot=(s)=>{ setVar('--primary',s.primary); setVar('--outline',s.outline); setVar('--bg',s.bg); setVar('--line',s.line); setVar('--radius',s.radius); setVar('--icon-stroke',s.iconStroke); setVar('--shadow-offset',s.shadow); if(s.outlineStyle) setVar('--outline-style',s.outlineStyle); if(s.iconCap) setVar('--icon-cap',s.iconCap); if(s.iconJoin) setVar('--icon-join',s.iconJoin); if(s.fontBody) setVar('--font-body',s.fontBody); if(s.fontHeading) setVar('--font-heading',s.fontHeading); if(s.fontScale) setVar('--font-scale',s.fontScale); if(s.cardFill) setVar('--card-fill',s.cardFill); if(s.sidebarBg) setVar('--sidebar-bg',s.sidebarBg); if(s.brandGradient) setVar('--brand-gradient',s.brandGradient); if(s.brandText) setVar('--brand-text-color',s.brandText); if(s.headline) setVar('--headline-gradient',s.headline); initStudioFromVars(); applyStudio(); };
  function renderPresetList(){ if(!studio.list) return; const items=loadPresets(); studio.list.innerHTML = items.map((p,i)=>`<div class="preset"><div style="display:flex;align-items:center"><span class="sw" style="background:${p.vars.bg}"></span>${p.name}</div><div style="display:flex;gap:6px"><button class="btn" data-act="apply" data-i="${i}">Apply</button><button class="btn" data-act="delete" data-i="${i}">Delete</button></div></div>`).join(''); studio.list.querySelectorAll('button').forEach(btn=>{btn.addEventListener('click',()=>{const i=+btn.dataset.i; const act=btn.dataset.act; const arr=loadPresets(); if(act==='apply') applySnapshot(arr[i].vars); if(act==='delete'){arr.splice(i,1); savePresets(arr); renderPresetList();}})}) }
  studio.inputs.saveBtn?.addEventListener('click',()=>{const name=studio.inputs.name.value.trim()||('Preset '+ new Date().toLocaleTimeString()); const arr=loadPresets(); arr.push({name, vars:varsSnapshot()}); savePresets(arr); renderPresetList();});
  studio.inputs.resetBtn?.addEventListener('click',()=>{['--primary','--outline','--bg','--line','--radius','--icon-stroke','--shadow-offset','--outline-style','--icon-cap','--icon-join','--font-body','--font-heading','--font-scale','--card-fill','--sidebar-bg','--brand-gradient','--brand-text-color','--headline-gradient'].forEach(v=>root.style.removeProperty(v)); initStudioFromVars(); applyStudio();});
  initStudioFromVars(); renderPresetList();

  // Quick palettes
  const QUICK=[
    {name:'Indigo', vars:{primary:'#6f5cff', outline:'#1f2346', bg:'linear-gradient(135deg,#f6f6fb 0%,#e7e4ff 60%,#ffffff 100%)', cardFill:'#ffffff'}},
    {name:'Ocean', vars:{primary:'#0aa', outline:'#0e1320', bg:'linear-gradient(135deg,#ecfeff 0%,#cffafe 50%,#e0f2fe 100%)', cardFill:'#ffffff'}},
    {name:'Sunrise', vars:{primary:'#ff6a4d', outline:'#1a1a1a', bg:'linear-gradient(135deg,#fff1f2 0%,#ffe4e6 50%,#fff7ed 100%)', cardFill:'#ffffff'}}
  ];
  if(studio.quick){ studio.quick.innerHTML = QUICK.map((p,i)=>`<button class="btn" data-i="${i}"><span class="sw" style="background:${p.vars.bg}; margin-right:6px"></span>${p.name}</button>`).join(''); studio.quick.querySelectorAll('button').forEach(btn=>{btn.addEventListener('click',()=>{const v=QUICK[+btn.dataset.i].vars; setVar('--primary',v.primary); setVar('--outline',v.outline); setVar('--bg',v.bg); setVar('--card-fill',v.cardFill); initStudioFromVars(); applyStudio();})}); }

  // Surprise me!
  function hslToHex(h,s,l){s/=100;l/=100;const k=n=>(n+h/30)%12;const a=s*Math.min(l,1-l);const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));const toHex=x=>('0'+Math.round(x*255).toString(16)).slice(-2);return '#'+toHex(f(0))+toHex(f(8))+toHex(f(4));}
  function rand(min,max){return Math.random()*(max-min)+min}
  function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
  function surpriseMe(){
    const bodyFonts=["Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial","DM Sans, Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial","Poppins, Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial","Space Grotesk, Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial","Karla, Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial"]; const headingFonts=bodyFonts;
    const primary=hslToHex(rand(0,360),rand(60,90),rand(45,60)); const outline='#1f2346'; const bgType=pick(['solid','linear','radial']); const bg1=hslToHex(rand(0,360),60,96); const bg2=hslToHex(rand(0,360),70,90); const bg3='#ffffff'; const angle=Math.floor(rand(0,360)); const line=Math.floor(rand(1,6)); const radius=Math.floor(rand(8,20)); const iconStroke=(Math.round(rand(18,30))/10).toFixed(1); const shadow=Math.floor(rand(3,10)); const outlineStyle=pick(['solid','dashed']); const iconEdge=pick(['round','miter']); const bodyFont=pick(bodyFonts); const headingFont=pick(headingFonts); const scale=(Math.round(rand(95,110))/100).toFixed(2); const cardType=pick(['plain','gradient']); const card1='#ffffff'; const card2=hslToHex(rand(0,360),60,97); const sbgType=pick(['solid','linear','radial']); const sbg1=hslToHex(rand(0,360),70,95); const sbg2=hslToHex(rand(0,360),70,90); const sbg3=hslToHex(rand(0,360),70,98); const sbgAngle=Math.floor(rand(0,360)); const brandType=pick(['solid','gradient']); const brandColor=outline; const brand1=primary; const brand2=hslToHex(rand(0,360),70,55); const headType=pick(['gradient','solid']); const head1=primary; const head2=hslToHex(rand(0,360),70,60);
    const set=(id,val)=>{if(studio.inputs[id]) studio.inputs[id].value=val}; ['primary','outline','bgType','bg1','bg2','bg3','angle','line','radius','iconStroke','shadow','outlineStyle','iconEdge','bodyFont','headingFont','scale','cardType','card1','card2','sbgType','sbg1','sbg2','sbg3','sbgAngle','brandType','brandColor','brand1','brand2','headType','head1','head2'].forEach(()=>{});
    set('primary',primary); set('outline',outline); set('bgType',bgType); set('bg1',bg1); set('bg2',bg2); set('bg3',bg3); set('angle',angle); set('line',line); set('radius',radius); set('iconStroke',iconStroke); set('shadow',shadow); set('outlineStyle',outlineStyle); set('iconEdge',iconEdge); set('bodyFont',bodyFont); set('headingFont',headingFont); set('scale',scale); set('cardType',cardType); set('card1',card1); set('card2',card2); set('sbgType',sbgType); set('sbg1',sbg1); set('sbg2',sbg2); set('sbg3',sbg3); set('sbgAngle',sbgAngle); set('brandType',brandType); set('brandColor',brandColor); set('brand1',brand1); set('brand2',brand2); set('headType',headType); set('head1',head1); set('head2',head2);
    applyStudio();
  }
  document.getElementById('stSurprise')?.addEventListener('click', surpriseMe);

  // Orders table & charts
  const ORDERS = [
    { no: 1, id: '#12345', date: 'Aug 6, 2020', name: 'Loid Forger', amount: 56.4, status: 'new' },
    { no: 2, id: '#12346', date: 'Aug 7, 2020', name: 'Anya Forger', amount: 75.9, status: 'delivery' },
    { no: 3, id: '#12347', date: 'Aug 8, 2020', name: 'Yor Briar', amount: 32.1, status: 'pending' },
    { no: 4, id: '#12348', date: 'Aug 9, 2020', name: 'Franky', amount: 98.4, status: 'new' },
  ];

  const tbody = document.getElementById('ordersBody');
  if (tbody) tbody.innerHTML = ORDERS.map(o => `
    <tr>
      <td>${o.no}.</td>
      <td>${o.id}</td>
      <td>${o.date}</td>
      <td>${o.name}</td>
      <td>$${o.amount.toFixed(2)}</td>
      <td><span class="status ${o.status}">${({new:'New Order',delivery:'On Delivery',pending:'Pending'})[o.status]}</span></td>
      <td><a class="link" href="#">Check</a></td>
    </tr>`).join('');

  if (window.Chart) {
    const revCtx = document.getElementById('chartRevenueArea');
    if (revCtx) new Chart(revCtx, {
      type: 'line',
      data: { labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
        datasets: [{ label:'Hits', data:[4,8,16,12,22,28,36,32,30,38,40,45], tension:.35,
          borderColor:getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
          backgroundColor:'rgba(111,92,255,0.15)', fill:true, pointRadius:0 }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{ x:{grid:{display:false}}, y:{grid:{color:'rgba(0,0,0,0.05)'}, ticks:{stepSize:10}} } }
    });

    const stackCtx = document.getElementById('chartSocialStack');
    if (stackCtx) new Chart(stackCtx, {
      type: 'bar',
      data: {
        labels: ['Jan','Feb','Mar','Apr','May','Jun'],
        datasets: [
          { label: 'Posts', data: [120,180,160,240,220,260], backgroundColor: '#6f5cff', borderRadius: 6 },
          { label: 'Carousels', data: [80,90,120,140,150,170], backgroundColor: '#5cc2ff', borderRadius: 6 },
          { label: 'Stories', data: [60,70,80,110,120,140], backgroundColor: '#ffa657', borderRadius: 6 }
        ]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{ x:{stacked:true, grid:{display:false}}, y:{stacked:true, grid:{color:'rgba(0,0,0,0.05)'}} } }
    });
  }

  // KPI progress bars
  try {
    document.getElementById('kpiRevBar').style.width = '71%';
    document.getElementById('kpiGMBar').style.width  = '38%';
    document.getElementById('kpiARBar').style.width  = '62%';
    document.getElementById('kpiOTPBar').style.width = '92%';
  } catch(_) {}
})();
</script>
